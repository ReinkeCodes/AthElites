rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to get user role from user document
    function getUserRole() {
      return get(/databases/$(database)/documents/user/$(request.auth.uid)).data.role;
    }

    // Helper: check if exercise is global/legacy (not client-private)
    function isGlobalExercise(data) {
      return !('createdByRole' in data) || data.createdByRole == null || data.createdByRole in ['coach', 'admin'];
    }

    // Helper: check if exercise is client-owned by current user
    function isOwnClientExercise(data) {
      return data.createdByRole == 'client' && data.createdByUserId == request.auth.uid;
    }

    // users collection
    match /user/{userId} {
      allow read, write: if request.auth != null;
    }

    // Helper: check if program is client-owned by current user
    function isOwnClientProgram(data) {
      return data.createdByRole == 'client' && data.createdByUserId == request.auth.uid;
    }

    // Helper: check if user is assigned to program
    function isAssignedToProgram(data) {
      return request.auth.uid in data.assignedTo;
    }

    // programs collection
    match /programs/{programId} {
      // READ:
      // - Coach/Admin: can read ALL programs (except client-created, filtered in UI)
      // - Client: can read programs assigned to them OR their own client-created programs
      allow read: if request.auth != null && (
        getUserRole() in ['coach', 'admin'] ||
        isAssignedToProgram(resource.data) ||
        isOwnClientProgram(resource.data)
      );

      // CREATE:
      // - Client: must set createdByRole='client', createdByUserId=own uid, assignedTo=[self only]
      // - Coach/Admin: can create any program
      allow create: if request.auth != null && (
        // Client create: must mark as client-owned and assign only to self
        (getUserRole() == 'client' &&
         request.resource.data.createdByRole == 'client' &&
         request.resource.data.createdByUserId == request.auth.uid &&
         request.resource.data.assignedTo.size() == 1 &&
         request.resource.data.assignedTo[0] == request.auth.uid) ||
        // Coach/Admin create: any program
        getUserRole() in ['coach', 'admin']
      );

      // UPDATE:
      // - Client: can update only their own client-created programs, cannot change ownership or assignedTo
      // - Coach/Admin: can update any program that is not client-created
      allow update: if request.auth != null && (
        // Client update: own client-created only, ownership and assignedTo unchanged
        (getUserRole() == 'client' &&
         isOwnClientProgram(resource.data) &&
         request.resource.data.createdByRole == resource.data.createdByRole &&
         request.resource.data.createdByUserId == resource.data.createdByUserId &&
         request.resource.data.assignedTo == resource.data.assignedTo) ||
        // Coach/Admin update: any non-client-created program
        (getUserRole() in ['coach', 'admin'] && resource.data.createdByRole != 'client')
      );

      // DELETE:
      // - Client: can delete only their own client-created programs
      // - Coach/Admin: can delete any program that is not client-created
      allow delete: if request.auth != null && (
        // Client delete: own client-created only
        (getUserRole() == 'client' && isOwnClientProgram(resource.data)) ||
        // Coach/Admin delete: any non-client-created program
        (getUserRole() in ['coach', 'admin'] && resource.data.createdByRole != 'client')
      );
    }

    // exercises collection
    match /exercises/{exerciseId} {
      // READ:
      // - Coach/Admin: can read ALL exercises
      // - Client: can read global/legacy + their own client-private exercises
      allow read: if request.auth != null && (
        getUserRole() in ['coach', 'admin'] ||
        isGlobalExercise(resource.data) ||
        isOwnClientExercise(resource.data)
      );

      // CREATE:
      // - Client: must set createdByRole='client' and createdByUserId=own uid
      // - Coach/Admin: can create global exercises (createdByRole in ['coach','admin'] or missing)
      allow create: if request.auth != null && (
        // Client create: must mark as client-owned
        (getUserRole() == 'client' &&
         request.resource.data.createdByRole == 'client' &&
         request.resource.data.createdByUserId == request.auth.uid) ||
        // Coach/Admin create: global exercises
        (getUserRole() in ['coach', 'admin'] &&
         (!('createdByRole' in request.resource.data) ||
          request.resource.data.createdByRole == null ||
          request.resource.data.createdByRole in ['coach', 'admin']))
      );

      // UPDATE:
      // - Client: can update only their own client-private exercises, cannot change ownership
      // - Coach/Admin: can update global/legacy exercises only
      allow update: if request.auth != null && (
        // Client update: own client-private only, ownership fields unchanged
        (getUserRole() == 'client' &&
         isOwnClientExercise(resource.data) &&
         request.resource.data.createdByRole == resource.data.createdByRole &&
         request.resource.data.createdByUserId == resource.data.createdByUserId) ||
        // Coach/Admin update: global/legacy only
        (getUserRole() in ['coach', 'admin'] && isGlobalExercise(resource.data))
      );

      // DELETE:
      // - Client: can delete only their own client-private exercises
      // - Coach/Admin: can delete global/legacy exercises only
      allow delete: if request.auth != null && (
        // Client delete: own client-private only
        (getUserRole() == 'client' && isOwnClientExercise(resource.data)) ||
        // Coach/Admin delete: global/legacy only
        (getUserRole() in ['coach', 'admin'] && isGlobalExercise(resource.data))
      );
    }

    // settings collection
    match /settings/{settingId} {
      allow read, write: if request.auth != null;
    }

    // workoutSessions: owner-only access
    match /workoutSessions/{sessionId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // workoutLogs: owner-only access
    match /workoutLogs/{logId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }
  }
}
